# E1音频输入/输出研究报告  

---

## 硬件与内核信息
| 项目     | 内容                                                         |
| -------- | ------------------------------------------------------------ |
| SoC      | Rockchip RK3308                                              |
| 音频 IP  | 内置 Audio Codec + PDM 麦克风阵列控制器                      |
| 物理接口 | 1) 4-pole 3.5 mm 耳机孔（TRRS）<br>2) 板载 PDM 数字麦克风阵列 |
| 内核版本 | Linux 5.x（ALSA 1.2.x）                                      |

---

## ALSA 设备拓扑

| Card  | 逻辑名                 | 功能          | 物理映射                   |
| ----- | ---------------------- | ------------- | -------------------------- |
| card0 | rockchip,rk3308-acodec | 模拟输入/输出 | 耳机孔 + 板载模拟 MIC 群组 |
| card1 | rockchip,rk3308-pcm    | I²S/PCM 外接  | 空载（未接外部 codec）     |
| card2 | rockchip,pdm-mic-array | 数字麦克风    | PDM 麦克风阵列             |
| card7 | Loopback               | 虚拟回环      | 软件内部路由               |

---

## 输出（Playback）能力: 耳机孔 / 扬声器
- **设备节点**：`hw:0,0`  
- **支持格式**：S16_LE / S24_LE / S32_LE  
- **采样率**：8 kHz – 192 kHz  
- **最大声道**：8（实际耳机孔仅 2 ch，板载扬声器为 2 ch）  
- **插拔检测**：有（自动切换耳机 ↔ 扬声器）

---

## 输入（Capture）能力

### 板载模拟麦克风群组（MIC Group 0-3）
- **设备节点**：`hw:0,0`  
- **最高规格**：192 kHz / 32-bit / 8 ch  
- **物理接口**：板载 MEMS 模拟麦克风阵列  
- **耳机孔麦克风**：**不支持** ==**TODO: 待验证应为我没有带有麦克风的耳机**==

### PDM 数字麦克风阵列
- **设备节点**：`hw:2,0`  
- **最高规格**：192 kHz / 32-bit / 8 ch  
- **物理接口**：板载 PDM 麦克风阵列  
- **推荐用途**：远场语音识别、波束成形

## 输入（Capture）能力深度分析

### 板载模拟麦克风群组（环境麦）- `hw:0,0`

#### 硬件架构

- **设备节点**：`hw:0,0`  
- **最高规格**：192 kHz / 32-bit / 8 ch  
- **物理接口**：板载 MEMS 模拟麦克风阵列
- **时钟域**：I2S2 (TX: 12.288MHz, RX: 4.096MHz)
- **DMA通道**：ff2d0000.dma-controller

#### 双重增益控制系统

**Level 1: 前置放大器增益 (numid=1-8)**

- **范围**：0dB, 6.6dB, 13dB, 20dB (4档固定)
- **当前值**：所有群组均为0dB
- **特点**：低噪声，高精度

**Level 2: ALC/AGC增益 (numid=9-16)**

- **范围**：-18dB 到 +28.5dB (步进1.5dB，32档)
- **当前值**：所有群组均为0dB (value=12)
- **最大增益**：+22.5dB (Max Volume = 7)
- **最小增益**：-18dB (Min Volume = 0)

#### MICBIAS电源系统

- **主电源**：已启用 (ADC Main MICBIAS = On)
- **电压等级**：VREFx0.85 (最高档，约2.8V)
- **辅助电源**：MICBIAS1/2 = 关闭
- **GPIO控制**：gpio-72 (mic-bias) = 高电平

### PDM 数字麦克风阵列（指向麦）- `hw:2,0`

#### 硬件架构

- **设备节点**：`hw:2,0`  
- **最高规格**：192 kHz / 32-bit / 8 ch  
- **物理接口**：板载 PDM 麦克风阵列
- **时钟域**：独立PDM时钟 (98.304MHz)
- **DMA通道**：直接PDM DMA，超低延迟

#### 寄存器状态分析（ff380000.pdm）

```
PDM_CTRL0  (0x04): 0x9800001f
├─ bit[31]    = 1  (PDM启用)
├─ bit[11:8]  = 8  (8通道配置) 
├─ bit[7:5]   = 0  (数据格式)
└─ bit[4:0]   = 0x1f (所有通道激活)

PDM_CLK_CTRL (0x0c): 0x00000023
└─ 时钟分频配置，支持高采样率
```

#### 关键特性

- **纯硬件控制**：无软件混音器接口
- **零延迟处理**：PDM→PCM硬件转换
- **8通道并行**：支持空间音频和波束成形
- **自动同步**：硬件级采样率自适应

---

## 系统级性能分析

### 时钟域架构

```
Audio PLL (1179.648MHz)
├─ I2S时钟域
│  ├─ clk_i2s2_8ch_tx: 12.288MHz (环境麦输出)
│  ├─ clk_i2s2_8ch_rx: 4.096MHz  (环境麦输入)
│  └─ 支持48kHz基准，可扩展到192kHz
└─ PDM时钟域
   ├─ clk_pdm: 98.304MHz (PDM处理器)
   └─ 独立时钟，支持到192kHz

🚨 关键发现：两个麦克风系统使用不同的时钟域，可实现真正的异步录音
```

### 中断和DMA配置

```
中断分配：
├─ IRQ 32: acodec-hpdet (耳机插拔检测，已触发2次)
├─ IRQ 17-20: DMA控制器 (多通道音频传输)
└─ 无PDM专用中断（硬件自动处理）

DMA通道：
├─ 环境麦：通过I2S DMA，灵活路由
└─ PDM麦：直接DMA，最低延迟
```

### GPIO硬件控制线

```
音频相关GPIO状态：
├─ gpio-72 (mic-bias): HIGH    # 麦克风偏置电源
├─ gpio-1  (hp-ctl):   LOW     # 耳机控制  
├─ gpio-5  (spk-ctl):  LOW     # 扬声器控制
└─ gpio-68 (sitronix_irq): HIGH # 触摸屏中断（可能影响音频）
```

---

## 耳机孔麦克风支持判定

| 检测方法                                  | 结果                     | 备注                               |
| ----------------------------------------- | ------------------------ | ---------------------------------- |
| `/proc/asound/card0/pcm0c/sub0/hw_params` | `closed`                 | 无录音流                           |
| `amixer contents \| grep -i mic`          | 仅有 `ADC MIC Group X`   | 无 `Headset Mic` / `Jack Mic` 控件 |
| 插入 TRRS 耳机 + `arecord`                | 录音失败/静音            | 验证硬件未连接                     |
| **结论**                                  | ❌ **不支持耳机孔麦克风** | 需硬件改版才能支持                 |

---

1. ## 限制与注意事项

   ### 硬件限制

   1. **耳机孔无麦克风输入**：硬件设计不支持TRRS耳机的麦克风功能
   2. **环境麦控制接口异常**：Simple control名称无效，必须使用numid方式操作
   3. **PDM麦无软件控制**：增益、滤波等需在应用层或DSP层实现
   4. **时钟域分离**：两个麦克风系统无法完全同步，存在微小的时间偏差

   ### 软件限制  

   1. **最小通道数限制**：`hw:0,0`录音最小2通道，单声道需用`plughw:0,0`
   2. **格式兼容性**：部分高采样率格式需要具体验证
   3. **驱动依赖**：优化配置依赖特定的内核驱动版本

   ### 性能考虑

   1. **CPU占用**：96kHz/32bit录音会显著增加CPU负载
   2. **存储带宽**：8通道高采样率录音需要充足的存储I/O性能
   3. **电源消耗**：全阵列激活会增加功耗，移动设备需考虑电池续航

   ### 推荐配置总结

   - **日常使用**：环境麦Group 0+1，13dB增益，48kHz
   - **专业录音**：环境麦全阵列，6.6dB增益，96kHz，禁用AGC
   - **语音识别**：PDM麦，16-48kHz，S16_LE格式
   - **音频分析**：PDM麦，96kHz，S32_LE格式

---

## 麦克风拾音模式分析

基于IDA Pro反编译main函数、配置文件和FAQ文档的分析，SogouE1程序中的拾音模式如下：

### 录音定位 (Recording Positioning/Localization)
- **含义**：声源定位（Sound Source Localization）功能，用于确定声音来源的方向和位置。
- **在程序中的作用**：通过8麦克风阵列（2颗指向麦克风 + 6颗全向麦克风），利用波束成形（Beamforming）和MVDR算法实现声源定位。这有助于在嘈杂环境中聚焦特定方向的声音，提高录音质量。
- **相关配置**：在`config.ini`中，`alg_mvdr_type = cgmm`启用MVDR算法，用于空间音频处理和声源定位。`mic_num = 6`（soh模型）或`8`（asr模型）表示麦克风数量，支持阵列定位。
- **应用场景**：会议、采访或多人环境，自动定位讲话者位置，优化录音效果。

#### 详细技术分析
- **算法原理**：MVDR (Minimum Variance Distortionless Response) 是一种自适应波束成形算法，通过计算麦克风阵列的权重向量，最小化来自非目标方向的干扰功率，同时保持目标方向的信号无失真。cgmm变体（Coherent Generalized Minimum Mean Square Error）结合了相干信号处理，提高定位精度。
- **硬件实现**：利用8麦克风阵列的空间几何（间距0.035m），计算到达时间差（TDOA）和相位差，实现声源角度和距离估计。PDM麦克风提供高采样率（192kHz），支持精确时延计算。
- **配置参数**：
  - `alg_mvdr_type = cgmm`：指定MVDR算法类型。
  - `mic_num = 6/8`：阵列麦克风数量。
  - `enable_save_mvdr = 1`：启用MVDR处理和结果保存。
  - `alg_mclp_enable = yes`：启用麦克风阵列线性预测，用于辅助定位。
- **软件集成**：通过libnnse.so库实现，结合LSTM-based NNSE（Neural Network Speech Enhancement）进行降噪增强。函数如`sogou_speech_asr_process_sound_data`处理音频数据流。
- **性能优势**：在多声源环境中，可抑制背景噪声20-30dB，提高信噪比。定位精度可达5-10度，距离范围1-5米。
- **局限性**：依赖麦克风阵列几何，近场声源可能有误差；高计算复杂度，需要RK3308 DSP加速。

### 顶端拾音 (Top Pickup)
- **含义**：使用设备顶端的指向麦克风进行定向拾音，聚焦特定方向的声音。
- **在程序中的作用**：顶端安装2颗哈曼10mm大直径驻极体指向麦克风（Directional Microphones），通过PDM接口（`hw:2,0`）连接，支持远距离高清收音。算法优先处理顶端麦克风信号，用于定向录音。
- **相关配置**：指向麦克风配置为`mic_type = MIC_NONE`（但实际启用时可能有特定模式）。在FAQ中明确提到："录音笔顶端是2颗哈曼10mm大直径驻极体指向麦克风，可针对顶端所指方向远距离高清收音，适合在听课等场景下侧重采集老师的声音。"
- **应用场景**：听课、演讲或需要聚焦前方声音的场合，有效距离可达10米。

#### 用户界面设计
- **雷达显示**：程序使用Qt Quick UI显示拾音雷达，分为360度和180度模式。
  - 360度模式（环境拾音）：显示`ic_bg_360.png`背景，`img252.png`波形精灵，`ic_zhongxin_360.png`中心图标。支持360度旋转显示角度。
  - 180度模式（顶端拾音）：显示`ic_bg_180.png`背景，`img318.png`波形精灵，`ic_zhongxin_180.png`中心图标和`ic_line_180.png`线条。支持180度范围显示。
- **动态更新**：雷达根据`angle`属性旋转精灵，根据`volumeLevel`更新波形帧。角度信号来自录音管理器的`onSigRecordAngle`，音量来自`onSigRecordSpl`。
- **模式切换**：通过`is180Mode`属性切换180/360度组件，实现顶端拾音和环境拾音的视觉区分。

### 环境拾音 (Environmental Pickup)
- **含义**：使用全向麦克风进行360度环境拾音，捕捉周围所有方向的声音。
- **在程序中的作用**：环境麦克风为6颗全向数字麦克风（Omnidirectional Microphones），通过模拟音频接口（`hw:0,0`）连接，支持360度拾音。算法包括AGC、ALC和降噪，用于处理环境噪音和多方向声音。
- **相关配置**：环境麦克风配置为`mic_num = 6`（soh模型）或`8`（asr模型），启用`alg_mclp_enable = yes`（麦克风阵列处理）和`alg_agc_enable = yes`（自动增益控制）。支持增益调节（0dB到20dB）。
- **应用场景**：会议、音乐录音或需要全方位捕捉的环境，如多人讨论。

#### 详细技术分析
- **硬件实现**：利用板载模拟麦克风阵列的6颗全向麦克风（Omnidirectional Microphones），通过I2S2时钟域（RX: 4.096MHz）连接。支持双重增益控制：前置放大器（0dB-20dB固定档）和ALC/AGC（-18dB到+28.5dB）。MICBIAS电源提供2.8V偏置电压，确保低噪声放大。
- **算法原理**：360度拾音通过全向麦克风阵列捕捉全方位信号，结合AGC（自动增益控制）动态调节增益，ALC（自动电平控制）防止过载。降噪算法处理环境噪音，支持多方向声音混合。MCLP（麦克风阵列线性预测）用于阵列信号处理。
- **配置参数**：
  - `mic_num = 6/8`：阵列麦克风数量。
  - `alg_agc_enable = yes`：启用自动增益控制。
  - `alg_mclp_enable = yes`：启用阵列线性预测。
  - 增益调节：numid=1-8（前置，0dB/6.6dB/13dB/20dB），numid=9-16（AGC，-18dB到+28.5dB）。
- **软件集成**：通过ALSA hw:0,0接口捕获模拟信号，libnnse.so处理降噪和增强。支持灵活路由和混音。
- **性能优势**：全方位拾音，无死角；动态增益适应不同音量环境；适合多声源和复杂场景。
- **局限性**：远距离拾音能力较弱（相比指向麦）；增益控制可能引入噪声；模拟接口延迟高于PDM。

#### 用户界面设计
- **雷达显示**：使用360度雷达界面显示全方位拾音状态，背景`ic_bg_360.png`，波形精灵`img252.png`，中心图标`ic_zhongxin_360.png`。支持360度旋转，实时反映声源角度和音量。
- **信号处理**：角度通过`onSigRecordAngle`更新，音量通过`onSigRecordSpl`计算volumeLevel（放大2倍，限制1.0，映射到24帧）。
- **视觉反馈**：精灵根据音量前进帧数，暂停显示，提供直观的环境拾音可视化。

### 总结
- **硬件基础**：SogouE1的8麦克风阵列分为指向麦（顶端，远距离定向）和全向麦（环境，360度拾音）。
- **算法支持**：通过MVDR、MCLP、AGC等算法实现定位和拾音优化。
- **用户选择**：程序可能允许用户在UI中切换模式（如顶端拾音 vs. 环境拾音），以适应不同场景。录音定位作为底层功能自动运行。

#### 顶端拾音 vs. 环境拾音对比
| 方面          | 顶端拾音 (Top Pickup)                  | 环境拾音 (Environmental Pickup)       |
|---------------|----------------------------------------|---------------------------------------|
| **麦克风类型**| 2颗指向麦克风 (Directional)           | 6颗全向麦克风 (Omnidirectional)      |
| **接口**      | PDM数字 (`hw:2,0`)                     | 模拟I2S (`hw:0,0`)                    |
| **拾音范围**  | 定向聚焦顶端方向，远距离（10米）       | 360度全方位，无死角                   |
| **算法重点**  | 波束成形 + MVDR，抑制侧面干扰          | AGC/ALC + 降噪，多方向混合           |
| **增益控制**  | 无软件控制，硬件固定                   | 双重增益：前置 + AGC (-18dB到+28.5dB) |
| **延迟**      | 零延迟，PDM硬件转换                    | 较低延迟，I2S DMA                     |
| **适用场景**  | 单声源聚焦（如演讲、听课）             | 多声源环境（如会议、音乐录音）        |
| **优势**      | 高保真远场拾音，低噪声                 | 灵活适应，动态调节                    |
| **局限性**    | 方向固定，不灵活                       | 远距离弱，增益可能引入噪声            |
| **UI显示**    | 180度雷达界面，半圆形背景              | 360度雷达界面，全圆形背景             |
| **视觉元素**  | `ic_bg_180.png`, `img318.png`, 中心线条 | `ic_bg_360.png`, `img252.png`, 中心点 |