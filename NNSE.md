# Sogou E1 NNSE 分析总结

## 概述
Sogou E1 使用专有的二进制模型格式实现了神经网络语音增强 (NNSE)，该格式针对 RK3308 上的嵌入式 DSP 处理进行了优化。该系统采用混合方法，将传统信号处理与神经网络相结合。

## 架构

### 库
- **libnnse.so**：高级 NNSE 接口、配置管理和音频处理管道
- **libnnse_nnet.so**：神经网络推理引擎，具有优化的 FFT/STFT 操作

### 模型文件
位于 `sogou/front-config/nnse/`：
- `nnse.conf.model.bin` (10.5MB)：主要的神经网络模型 (基于 LSTM)
- `nnse.conf.ms.bin` (4KB)：掩码估计或次要模型

## 二进制模型格式

### 头部结构 (16 字节)
```
偏移量  大小    描述
0x00    4       模型类型/版本 (int32, 小端)
0x04    4       输入维度 (int32)
0x08    4       批次大小 (int32)
0x0C    4       输出维度 (int32)
```

### 数据段
- 头部后的 Float32 权重/偏置
- 小端字节顺序
- 无压缩或量化

### 示例分析
**nnse.conf.model.bin**：
- 类型：7
- 输入维度：512
- 批次大小：1
- 输出维度：1
- 权重：~2.6M float32 值

**nnse.conf.ms.bin**：
- 类型：16000
- 输入维度：1024
- 批次大小：2
- 输出维度：2
- 权重：~1K float32 值

## 配置系统

### nnse.conf 参数
从 `load_nnse_conf()` 中提取的关键参数：
- `NNSE_MODEL_SUFFIX`：模型文件后缀 (.bin)
- `NNSE_MS_SUFFIX`：掩码估计后缀 (.bin)
- FFT 大小、窗口长度、跳跃大小
- 增益控制参数
- 模型特定维度

## 处理管道

### 音频流
1. **输入**：原始音频样本
2. **STFT**：使用优化的 FFT 转换为频域
3. **神经增强**：应用 LSTM/CRN 模型进行降噪
4. **掩码估计**：生成频谱掩码
5. **ISTFT**：转换回时域
6. **输出**：增强的音频

### 关键函数
- `nnse_process()`：主要处理入口点
- `sogou_nnet_init()`：模型初始化 (thunk 到实际实现)
- `MA::Cstft::stft_process()`：具有 SIMD 优化的 STFT 处理
- `MA::Cnnse::alloc_mem()`：为神经网络缓冲区分配内存

## 技术特性

### 优化
- **SIMD 处理**：广泛使用 NEON 指令用于 ARM DSP
- **定点运算**：针对嵌入式约束优化
- **内存池化**：预分配缓冲区以实现实时性能
- **自定义格式**：针对 RK3308 加载优化的二进制格式

### 模型类型
- **LSTM**：用于音频序列的时间建模
- **CRN (复杂比率网络)**：用于频谱增强
- **掩码估计**：用于噪声抑制的二进制/概率掩码

## 使用说明

### 模型兼容性
- **不兼容 ONNX**：自定义二进制格式，不是标准 ML 框架
- **硬件特定**：针对 RK3308 DSP 优化，可能无法在其他平台上运行
- **实时约束**：设计用于低延迟音频处理

### 开发考虑
- 需要 RK3308 或兼容的 ARM DSP
- 用于模型训练/转换的自定义工具链
- 配置驱动的模型加载
- SIMD 优化的信号处理库

## 逆向工程状态

### 已完成
- 二进制格式规范
- 配置参数提取
- 高级处理管道理解
- 内存分配模式分析

### 部分完成
- 神经网络模型加载 (thunk 函数已识别，实际实现待定)
- 详细的权重/偏置布局规范

### 待定
- 完整的模型加载实现
- 训练/转换工具链细节
- 性能基准测试数据